from aiogram import types, Dispatcher
from aiogram.dispatcher import FSMContext
from datetime import datetime, timedelta
from database.models import User
from database import get_db
from config.config import SUBSCRIPTION_PRICE, FREE_TRIAL_DAYS

async def check_subscription(message: types.Message):
    db = next(get_db())
    user = db.query(User).filter(User.telegram_id == message.from_user.id).first()
    
    if not user:
        await message.answer("ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, ÑĞ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿Ñ€Ğ¾Ğ¹Ğ´Ğ¸Ñ‚Ğµ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ /start")
        return False
        
    if user.is_subscribed:
        days_left = (user.subscription_end_date - datetime.utcnow()).days
        if days_left > 0:
            return True
            
    registration_days = (datetime.utcnow() - user.registration_date).days
    if registration_days <= FREE_TRIAL_DAYS:
        return True
        
    await message.answer(
        f"Ğ”Ğ»Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº ÑÑ‚Ğ¾Ğ¹ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ° Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ°.\n"
        f"Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ: {SUBSCRIPTION_PRICE} Ñ€ÑƒĞ±/Ğ¼ĞµÑÑÑ†\n"
        f"Ğ”Ğ»Ñ Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñƒ /subscribe"
    )
    return False

async def subscribe(message: types.Message):
    # Ğ—Ğ´ĞµÑÑŒ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ñ‹Ñ‚ÑŒ Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ Ñ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ½Ğ¾Ğ¹ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ¾Ğ¹
    # Ğ’ Ğ´Ğ°Ğ½Ğ½Ğ¾Ğ¼ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ğµ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ¸Ğ¼Ğ¸Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ ÑƒÑĞ¿ĞµÑˆĞ½ÑƒÑ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñƒ
    
    db = next(get_db())
    user = db.query(User).filter(User.telegram_id == message.from_user.id).first()
    
    if user.is_subscribed:
        await message.answer("Ğ£ Ğ²Ğ°Ñ ÑƒĞ¶Ğµ ĞµÑÑ‚ÑŒ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ°Ñ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ°!")
        return
        
    user.is_subscribed = True
    user.subscription_end_date = datetime.utcnow() + timedelta(days=30)
    db.commit()
    
    await message.answer(
        "ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ»ĞµĞ½Ğ°! ğŸ‰\n"
        "Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ²Ğ°Ğ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹ Ğ²ÑĞµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ğ±Ğ¾Ñ‚Ğ° Ğ½Ğ° 30 Ğ´Ğ½ĞµĞ¹."
    )

def register_subscription_handlers(dp: Dispatcher):
    dp.register_message_handler(subscribe, commands=["subscribe"]) 